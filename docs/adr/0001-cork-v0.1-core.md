# ADR 0001: CORK v0.1 Core仕様の採用

- ステータス: 承認
- 日付: 2025-01-01

## コンテキスト
CORKは、LLM/Tool実行の並行・順序保持・依存管理・制約執行・ログ回収・再現性を単一のKernelで統一的に提供する必要がある。既存のAgentフレームワークは、動的グラフ拡張や履歴の再構成、期限/資源制約の強制に弱い。また将来的にジョブショップ最適化やHTN/SHOP3の階層型計画を統合するため、v0.1から拡張可能なメタモデルが必要である。

## 決定
以下をv0.1の中核仕様として採用する。

1. **二層グラフ（Contract + Expansion）**
   - Contract Graphで必須順序を保証し、Expansion GraphはGraphPatchで動的拡張する。
2. **Structured Concurrency（Scope）**
   - 実行単位をScopeで管理し、キャンセル・期限・ログ相関を伝播させる。
3. **順序付けの3層モデル**
   - Contract order / Precedence / Resource feasibility の3層を定義する。
4. **イベントソーシング**
   - すべての状態遷移とGraphPatchをEvent Logに記録し、再構成可能とする。
5. **JSON正規化とハッシュ**
   - RFC 8785 (JCS) に基づく決定的JSON表現とdomain separation付きハッシュを採用する。
6. **gRPC deadline/cancelの厳密伝播**
   - Core↔Worker間はgRPCで接続し、deadline/cancelを必ず伝播させる。
7. **将来の最適化/HTN対応メタデータ**
   - SchedulingProfileとHTNメタデータをv0.1から定義する。

## 影響
- Contract/Policy/GraphPatchのJSON Schemaを整備し、Composite Graphの再現性を保証する。
- Event Logを一次情報源とし、UIは決定的ログマージで表示する。
- Planner/Optimizerの実装は外部に委譲しつつ、Kernelが順序・資源・制約を統制する。

## 代替案
- すべての順序を静的Graphで固定する案
  - 動的拡張が困難で、実験・探索用途に適さないため却下。
- 各Workerが独自にログ収集する案
  - ログの整合性や再構成が困難なため却下。

## 参照
- `docs/specification.md`
- `docs/canonicalization.md`
- `docs/hashing.md`

