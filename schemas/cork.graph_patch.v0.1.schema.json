{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "cork.graph_patch.v0.1",
  "title": "CORK GraphPatch v0.1",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "run_id", "patch_seq", "stage_id", "ops"],
  "properties": {
    "schema_version": { "type": "string", "const": "cork.graph_patch.v0.1" },
    "run_id": { "type": "string", "minLength": 8, "maxLength": 128 },
    "patch_seq": { "type": "integer", "minimum": 0, "maximum": 1000000000 },
    "emitted_at_unix_ms": { "type": "integer", "minimum": 0, "maximum": 32503680000000 },
    "stage_id": { "$ref": "#/$defs/StageId" },
    "ops": {
      "type": "array",
      "minItems": 1,
      "maxItems": 100000,
      "items": { "$ref": "#/$defs/PatchOp" }
    }
  },
  "$defs": {
    "StageId": { "type": "string", "pattern": "^[A-Za-z][A-Za-z0-9_\\-]{0,63}$" },
    "NodeId": { "type": "string", "minLength": 1, "maxLength": 256 },
    "AnchorPosition": { "type": "string", "enum": ["PRE", "WITHIN", "POST"] },
    "NodeKind": { "type": "string", "enum": ["LLM", "TOOL", "MERGE", "SWITCH", "LOOP", "BARRIER"] },

    "JsonPointer": { "type": "string", "description": "RFC 6901 JSON Pointer" },

    "Payload": {
      "type": "object",
      "additionalProperties": false,
      "required": ["content_type", "data_base64"],
      "properties": {
        "content_type": { "type": "string", "maxLength": 128 },
        "data_base64": { "type": "string" },
        "sha256_hex": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      }
    },

    "ArtifactRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["uri", "sha256_hex"],
      "properties": {
        "uri": { "type": "string", "maxLength": 2048 },
        "sha256_hex": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "content_type": { "type": "string", "maxLength": 128 },
        "size_bytes": { "type": "integer", "minimum": 0, "maximum": 1099511627776 }
      }
    },

    "ValueRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ref_type"],
      "properties": {
        "ref_type": {
          "type": "string",
          "enum": ["RUN_STATE", "STAGE_STATE", "NODE_OUTPUT", "NODE_ARTIFACT"]
        },
        "json_pointer": { "$ref": "#/$defs/JsonPointer" },
        "stage_id": { "$ref": "#/$defs/StageId" },
        "node_id": { "$ref": "#/$defs/NodeId" },
        "artifact_index": { "type": "integer", "minimum": 0, "maximum": 1000000 },
        "render_as": { "type": "string", "enum": ["JSON_COMPACT", "JSON_PRETTY", "TEXT"] }
      },
      "allOf": [
        {
          "if": { "properties": { "ref_type": { "const": "RUN_STATE" } } },
          "then": { "required": ["json_pointer"] }
        },
        {
          "if": { "properties": { "ref_type": { "const": "STAGE_STATE" } } },
          "then": { "required": ["stage_id", "json_pointer"] }
        },
        {
          "if": { "properties": { "ref_type": { "const": "NODE_OUTPUT" } } },
          "then": { "required": ["node_id", "json_pointer"] }
        },
        {
          "if": { "properties": { "ref_type": { "const": "NODE_ARTIFACT" } } },
          "then": { "required": ["node_id", "artifact_index"] }
        }
      ]
    },

    "InputSpec": {
      "type": "object",
      "additionalProperties": false,
      "oneOf": [
        { "required": ["literal"], "properties": { "literal": { "$ref": "#/$defs/Payload" } } },
        { "required": ["artifact"], "properties": { "artifact": { "$ref": "#/$defs/ArtifactRef" } } },
        { "required": ["ref"], "properties": { "ref": { "$ref": "#/$defs/ValueRef" } } }
      ]
    },

    "CachePolicy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "ttl_ms": { "type": "integer", "minimum": 0, "maximum": 31536000000 },
        "key_override": { "type": "string", "maxLength": 512 },
        "key_parts": { "type": "array", "items": { "type": "string", "maxLength": 64 } }
      }
    },

    "ToolExec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tool_name", "tool_version", "input", "side_effect"],
      "properties": {
        "tool_name": { "type": "string", "maxLength": 128 },
        "tool_version": { "type": "string", "maxLength": 128 },
        "input": { "$ref": "#/$defs/InputSpec" },
        "side_effect": {
          "type": "string",
          "enum": ["NONE", "EXTERNAL_WRITE", "PAYMENT", "IRREVERSIBLE"]
        },
        "idempotency_key": { "type": "string", "maxLength": 256 },
        "cache": { "$ref": "#/$defs/CachePolicy" }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "side_effect": {
                "enum": ["EXTERNAL_WRITE", "PAYMENT", "IRREVERSIBLE"]
              }
            }
          },
          "then": { "required": ["idempotency_key"] }
        }
      ]
    },

    "LlmMessagePart": {
      "type": "object",
      "additionalProperties": false,
      "oneOf": [
        { "required": ["text"], "properties": { "text": { "type": "string", "maxLength": 2000000 } } },
        { "required": ["ref"], "properties": { "ref": { "$ref": "#/$defs/ValueRef" } } }
      ]
    },

    "LlmMessage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["role", "parts"],
      "properties": {
        "role": { "type": "string", "enum": ["system", "user", "assistant", "tool"] },
        "name": { "type": "string", "maxLength": 128 },
        "parts": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/LlmMessagePart" } }
      }
    },

    "LlmExec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["provider", "model", "messages"],
      "properties": {
        "provider": { "type": "string", "maxLength": 64 },
        "model": { "type": "string", "maxLength": 128 },
        "messages": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/LlmMessage" } },
        "temperature": { "type": "number", "minimum": 0, "maximum": 2 },
        "top_p": { "type": "number", "minimum": 0, "maximum": 1 },
        "max_output_tokens": { "type": "integer", "minimum": 0, "maximum": 1000000 },
        "stop": { "type": "array", "items": { "type": "string", "maxLength": 128 } },
        "response_format": { "type": "string", "enum": ["text", "json"] }
      }
    },

    "MergeStrategy": { "type": "string", "enum": ["ALL", "FIRST_SUCCESS", "K_OF_N", "QUORUM", "REDUCE"] },
    "MergeInputOrder": { "type": "string", "enum": ["STABLE_SORT", "AS_SPECIFIED"] },

    "MergeExec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["strategy", "inputs", "input_order"],
      "properties": {
        "strategy": { "$ref": "#/$defs/MergeStrategy" },
        "inputs": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/NodeId" } },
        "input_order": { "$ref": "#/$defs/MergeInputOrder" },
        "k": { "type": "integer", "minimum": 1, "maximum": 1000000 },
        "quorum": { "type": "integer", "minimum": 1, "maximum": 1000000 },
        "reducer": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "type": "string", "maxLength": 128 },
            "config": { "type": "object", "additionalProperties": true }
          }
        }
      }
    },

    "SwitchBranch": {
      "type": "object",
      "additionalProperties": false,
      "required": ["when", "goto_node"],
      "properties": {
        "when": { "type": "string", "maxLength": 4096 },
        "goto_node": { "$ref": "#/$defs/NodeId" }
      }
    },

    "SwitchExec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["branches", "default_goto_node"],
      "properties": {
        "branches": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/SwitchBranch" } },
        "default_goto_node": { "$ref": "#/$defs/NodeId" }
      }
    },

    "LoopExec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["max_iters", "body_entry"],
      "properties": {
        "max_iters": { "type": "integer", "minimum": 1, "maximum": 1000000 },
        "body_entry": { "$ref": "#/$defs/NodeId" },
        "stop_condition": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["ALWAYS_FALSE", "ALWAYS_TRUE", "STATE_PREDICATE", "LLM_JUDGE"]
            },
            "expr": { "type": "string", "maxLength": 4096 },
            "judge_llm": { "$ref": "#/$defs/LlmExec" }
          }
        }
      }
    },

    "BarrierExec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["inputs"],
      "properties": {
        "inputs": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/NodeId" } }
      }
    },

    "ResourceRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["resource_id", "amount"],
      "properties": {
        "resource_id": { "type": "string", "maxLength": 128 },
        "amount": { "type": "integer", "minimum": 1, "maximum": 1000000 }
      }
    },

    "ResourceAlternative": {
      "type": "object",
      "additionalProperties": false,
      "required": ["resource_id", "estimated_duration_ms"],
      "properties": {
        "resource_id": { "type": "string", "maxLength": 128 },
        "estimated_duration_ms": { "type": "integer", "minimum": 0, "maximum": 604800000 }
      }
    },

    "SchedulingProfile": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "estimated_duration_ms": { "type": "integer", "minimum": 0, "maximum": 604800000 },
        "priority": { "type": "integer", "minimum": -1000000, "maximum": 1000000 },
        "resources": { "type": "array", "items": { "$ref": "#/$defs/ResourceRequest" } },
        "alternatives": { "type": "array", "items": { "$ref": "#/$defs/ResourceAlternative" } },
        "earliest_start_unix_ms": { "type": "integer", "minimum": 0, "maximum": 32503680000000 },
        "deadline_unix_ms": { "type": "integer", "minimum": 0, "maximum": 32503680000000 }
      }
    },

    "HtnMeta": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "task_network_id": { "type": "string", "maxLength": 128 },
        "task_id": { "type": "string", "maxLength": 128 },
        "parent_task_id": { "type": "string", "maxLength": 128 },
        "task_name": { "type": "string", "maxLength": 128 },
        "task_args_json": { "type": "string", "maxLength": 200000 },
        "task_type": { "type": "string", "enum": ["PRIMITIVE", "COMPOUND"] },
        "method_name": { "type": "string", "maxLength": 128 },
        "operator_name": { "type": "string", "maxLength": 128 },
        "decomposition_depth": { "type": "integer", "minimum": 0, "maximum": 100000 }
      }
    },

    "DynamicNode": {
      "type": "object",
      "additionalProperties": false,
      "required": ["node_id", "kind", "anchor_position", "deps", "exec"],
      "properties": {
        "node_id": { "$ref": "#/$defs/NodeId" },
        "kind": { "$ref": "#/$defs/NodeKind" },
        "anchor_position": { "$ref": "#/$defs/AnchorPosition" },
        "deps": { "type": "array", "items": { "$ref": "#/$defs/NodeId" } },

        "ttl_ms": { "type": "integer", "minimum": 0, "maximum": 31536000000 },

        "scheduling": { "$ref": "#/$defs/SchedulingProfile" },
        "htn": { "$ref": "#/$defs/HtnMeta" },

        "exec": {
          "oneOf": [
            { "required": ["tool"], "properties": { "tool": { "$ref": "#/$defs/ToolExec" } } },
            { "required": ["llm"], "properties": { "llm": { "$ref": "#/$defs/LlmExec" } } },
            { "required": ["merge"], "properties": { "merge": { "$ref": "#/$defs/MergeExec" } } },
            { "required": ["switch"], "properties": { "switch": { "$ref": "#/$defs/SwitchExec" } } },
            { "required": ["loop"], "properties": { "loop": { "$ref": "#/$defs/LoopExec" } } },
            { "required": ["barrier"], "properties": { "barrier": { "$ref": "#/$defs/BarrierExec" } } }
          ]
        }
      }
    },

    "StatePut": {
      "type": "object",
      "additionalProperties": false,
      "required": ["scope", "json_pointer", "value"],
      "properties": {
        "scope": { "type": "string", "enum": ["RUN", "STAGE"] },
        "stage_id": { "$ref": "#/$defs/StageId" },
        "json_pointer": { "$ref": "#/$defs/JsonPointer" },
        "value": { "$ref": "#/$defs/InputSpec" }
      },
      "allOf": [
        {
          "if": { "properties": { "scope": { "const": "STAGE" } } },
          "then": { "required": ["stage_id"] }
        }
      ]
    },

    "PatchOp": {
      "type": "object",
      "additionalProperties": false,
      "required": ["op_type"],
      "properties": {
        "op_type": {
          "type": "string",
          "enum": ["NODE_ADDED", "EDGE_ADDED", "STATE_PUT", "NODE_UPDATED"]
        },

        "node_added": {
          "type": "object",
          "additionalProperties": false,
          "required": ["node"],
          "properties": { "node": { "$ref": "#/$defs/DynamicNode" } }
        },

        "edge_added": {
          "type": "object",
          "additionalProperties": false,
          "required": ["from", "to"],
          "properties": { "from": { "$ref": "#/$defs/NodeId" }, "to": { "$ref": "#/$defs/NodeId" } }
        },

        "state_put": { "$ref": "#/$defs/StatePut" },

        "node_updated": {
          "type": "object",
          "additionalProperties": false,
          "required": ["node_id", "patch"],
          "properties": {
            "node_id": { "$ref": "#/$defs/NodeId" },
            "patch": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "ttl_ms": { "type": "integer", "minimum": 0, "maximum": 31536000000 },
                "scheduling": { "$ref": "#/$defs/SchedulingProfile" },
                "htn": { "$ref": "#/$defs/HtnMeta" }
              }
            }
          }
        }
      },
      "allOf": [
        {
          "if": { "properties": { "op_type": { "const": "NODE_ADDED" } } },
          "then": { "required": ["node_added"] }
        },
        {
          "if": { "properties": { "op_type": { "const": "EDGE_ADDED" } } },
          "then": { "required": ["edge_added"] }
        },
        {
          "if": { "properties": { "op_type": { "const": "STATE_PUT" } } },
          "then": { "required": ["state_put"] }
        },
        {
          "if": { "properties": { "op_type": { "const": "NODE_UPDATED" } } },
          "then": { "required": ["node_updated"] }
        }
      ]
    }
  }
}
